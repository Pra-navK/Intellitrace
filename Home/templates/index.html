<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Python Execution Visualizer</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    :root {
      --background: linear-gradient(135deg, #0f111a 0%, #1a1d29 100%);
      --panel: rgba(26, 29, 41, 0.9);
      --panel-border: rgba(58, 140, 255, 0.1);
      --highlight: #3a8cff;
      --text: #e0e0e0;
      --text-secondary: #a0a0a0;
      --frame-bg: rgba(17, 19, 29, 0.8);
      --frame-border: rgba(58, 140, 255, 0.2);
      --btn-bg: linear-gradient(135deg, #3a8cff 0%, #1f6fe5 100%);
      --btn-hover: linear-gradient(135deg, #1f6fe5 0%, #0d5bdb 100%);
      --accent: #00c37a;
      --accent-bg: linear-gradient(135deg, #00c37a 0%, #00a866 100%);
      --error: #ff4757;
      --warning: #ffa502;
      --success: #2ed573;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
    }

    .container {
      max-width: 1600px;
      margin: auto;
      padding: 2rem;
    }

    h1 {
      text-align: center;
      background: linear-gradient(135deg, var(--highlight) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 2rem;
      text-shadow: 0 0 30px rgba(58, 140, 255, 0.3);
    }

    textarea {
      width: 100%;
      height: 350px;
      background: var(--panel);
      color: var(--text);
      border: 2px solid var(--panel-border);
      padding: 1.5rem;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 1rem;
      line-height: 1.6;
      border-radius: 12px;
      resize: vertical;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      backdrop-filter: blur(10px);
    }

    textarea:focus {
      outline: none;
      border-color: var(--highlight);
      box-shadow: 0 0 20px rgba(58, 140, 255, 0.2);
    }

    button {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      background: var(--btn-bg);
      color: white;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(58, 140, 255, 0.3);
      position: relative;
      overflow: hidden;
    }

    button:hover {
      background: var(--btn-hover);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(58, 140, 255, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button.accent {
      background: var(--accent-bg);
      box-shadow: 0 4px 15px rgba(0, 195, 122, 0.3);
    }

    button.accent:hover {
      box-shadow: 0 6px 20px rgba(0, 195, 122, 0.4);
    }

    .flex {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .panel {
      flex: 1;
      min-width: 300px;
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--highlight), transparent);
    }

    .panel h2 {
      margin: 0 0 1.5rem;
      color: var(--highlight);
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .stack-frame {
      background: var(--frame-bg);
      border: 1px solid var(--frame-border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .stack-frame:hover {
      border-color: var(--highlight);
      box-shadow: 0 4px 20px rgba(58, 140, 255, 0.15);
    }

    .stack-frame h3 {
      margin: 0 0 1rem;
      color: var(--highlight);
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .stack-frame h3::before {
      content: 'üì¶';
      font-size: 0.9rem;
    }

    .variable {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      margin: 4px 0;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 6px;
      border-left: 3px solid var(--accent);
      transition: background 0.2s ease;
    }

    .variable:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .variable-name {
      color: var(--text);
      font-weight: 500;
    }

    .variable-value {
      color: var(--text-secondary);
      font-style: italic;
    }

    .highlight-line {
      background: linear-gradient(90deg, rgba(58, 140, 255, 0.15), rgba(58, 140, 255, 0.05));
      border-left: 4px solid var(--highlight);
      padding-left: 1rem;
      margin-left: -1rem;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { background: linear-gradient(90deg, rgba(58, 140, 255, 0.15), rgba(58, 140, 255, 0.05)); }
      50% { background: linear-gradient(90deg, rgba(58, 140, 255, 0.25), rgba(58, 140, 255, 0.1)); }
    }

    .controls {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 2rem 0;
      background: var(--panel);
      border: 1px solid var(--panel-border);
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }

    .step-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-left: auto;
    }

    #stepSlider {
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      outline: none;
      min-width: 200px;
    }

    #stepSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: var(--highlight);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(58, 140, 255, 0.5);
    }

    #stepSlider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: var(--highlight);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 10px rgba(58, 140, 255, 0.5);
    }

    .output-section {
      background: rgba(0, 255, 255, 0.05);
      border: 1px solid rgba(0, 255, 255, 0.2);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1.5rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
    }

    .output-section h4 {
      margin: 0 0 0.5rem;
      color: var(--accent);
      font-size: 0.9rem;
      font-weight: 600;
    }

    pre {
      overflow-x: auto;
      background: rgba(0, 0, 0, 0.4);
      padding: 1.5rem;
      border-radius: 12px;
      margin: 0;
      border: 1px solid rgba(58, 140, 255, 0.1);
      font-family: 'JetBrains Mono', monospace;
      line-height: 1.6;
    }

    .code-line {
      padding: 2px 0;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    .loading::after {
      content: '';
      width: 20px;
      height: 20px;
      border: 2px solid var(--highlight);
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 0.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: rgba(255, 71, 87, 0.1);
      border: 1px solid var(--error);
      color: var(--error);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }

    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .flex { flex-direction: column; }
      .controls { flex-direction: column; align-items: stretch; }
      .step-info { margin-left: 0; justify-content: center; }
      #stepSlider { min-width: 100%; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>üêç Python Execution Visualizer</h1>

  <div id="codeInput">
    <textarea id="codeEditor" placeholder="# Write your Python code here...&#10;# The visualizer will show step-by-step execution&#10;&#10;def factorial(n):&#10;    if n <= 1:&#10;        return 1&#10;    return n * factorial(n - 1)&#10;&#10;result = factorial(5)&#10;print(f'Factorial of 5 is {result}')"></textarea>
    <div style="text-align:right; margin-top:1rem">
      <button onclick="submitCode()">üöÄ Start Visualization</button>
    </div>
  </div>

  <div id="visualizer" style="display:none">
    <div class="controls">
      <button onclick="prevStep()" id="prevBtn">‚èÆÔ∏è Previous</button>
      <button onclick="nextStep()" id="nextBtn">Next ‚è≠Ô∏è</button>
      <input type="range" id="stepSlider" min="0" value="0">
      <div class="step-info">
        <span id="stepLabel">Step 0/0</span>
        <button onclick="editCode()" class="accent">‚úèÔ∏è Edit Code</button>
      </div>
    </div>

    <div class="flex">
      <div class="panel">
        <h2>üíª Code Execution</h2>
        <pre id="codeDisplay"></pre>
        <div id="outputSection" class="output-section" style="display:none">
          <h4>üìã Step Information</h4>
          <div id="output"></div>
        </div>
      </div>
      <div class="panel">
        <h2>üîç Stack Frames & Variables</h2>
        <div id="framesContainer">
          <div class="loading">Loading execution trace...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let trace = [];
  let step = 0;
  let code = '';

  function submitCode() {
    code = document.getElementById('codeEditor').value.trim();
    
    if (!code) {
      alert('Please enter some Python code to visualize!');
      return;
    }

    // Show loading state
    document.getElementById('codeInput').style.display = 'none';
    document.getElementById('visualizer').style.display = 'block';
    document.getElementById('framesContainer').innerHTML = '<div class="loading">Generating execution trace...</div>';

    // Make API call to backend
    fetch('/api/trace/', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ code })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      trace = data;
      step = 0;
      setupVisualization();
      renderStep();
    })
    .catch(error => {
      console.error('Error:', error);
      document.getElementById('framesContainer').innerHTML = 
        `<div class="error-message">
          <strong>Error:</strong> ${error.message}
          <br><br>
          Please check your code and try again, or ensure the backend server is running.
        </div>`;
    });
  }

  function setupVisualization() {
    const maxSteps = Math.max(0, trace.length - 1);
    document.getElementById('stepSlider').max = maxSteps;
    updateControls();
  }

  function updateControls() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    prevBtn.disabled = step === 0;
    nextBtn.disabled = step >= trace.length - 1;
    
    prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
    nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
  }

  function renderStep() {
    if (!trace.length) return;

    const currentStep = trace[step];
    
    // Update step label
    document.getElementById('stepLabel').innerText = `Step ${step + 1}/${trace.length}`;
    document.getElementById('stepSlider').value = step;

    // Render code with highlighting
    renderCodeWithHighlight(currentStep.line);
    
    // Render stack frames and variables
    renderStackFrames(currentStep);
    
    // Show step information if available
    renderStepInfo(currentStep);
    
    // Update control states
    updateControls();
  }

  function renderCodeWithHighlight(currentLine) {
    const codeLines = code.split('\n');
    const codeDisplay = document.getElementById('codeDisplay');
    codeDisplay.innerHTML = '';

    codeLines.forEach((line, index) => {
      const lineDiv = document.createElement('div');
      lineDiv.className = 'code-line';
      lineDiv.textContent = line || ' '; // Handle empty lines
      
      // Highlight current line (backend provides 1-based line numbers)
      if (currentLine && index + 1 === currentLine) {
        lineDiv.classList.add('highlight-line');
      }
      
      codeDisplay.appendChild(lineDiv);
    });
  }

  function renderStackFrames(stepData) {
    const container = document.getElementById('framesContainer');
    container.innerHTML = '';

    // Collect all frames
    const allFrames = [];
    
    // Add global frame if global variables exist
    if (stepData.variables && stepData.variables.global) {
      allFrames.push({ 
        function: 'global', 
        locals: stepData.variables.global 
      });
    }

    // Add stack frames if they exist
    if (stepData.stack && stepData.stack.length > 0) {
      allFrames.push(...stepData.stack);
    }

    // Render frames or show message if no frames
    if (allFrames.length === 0) {
      container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">No active stack frames</div>';
      return;
    }

    allFrames.forEach(frame => {
      container.appendChild(createStackFrame(frame.function, frame.locals || {}));
    });
  }

  function createStackFrame(functionName, variables) {
    const frame = document.createElement('div');
    frame.className = 'stack-frame';
    
    const header = document.createElement('h3');
    header.textContent = functionName;
    frame.appendChild(header);

    // Add variables
    const varKeys = Object.keys(variables);
    if (varKeys.length === 0) {
      const noVars = document.createElement('div');
      noVars.style.color = 'var(--text-secondary)';
      noVars.style.fontStyle = 'italic';
      noVars.textContent = 'No variables';
      frame.appendChild(noVars);
    } else {
      varKeys.forEach(key => {
        const varRow = document.createElement('div');
        varRow.className = 'variable';
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'variable-name';
        nameSpan.textContent = key;
        
        const valueSpan = document.createElement('span');
        valueSpan.className = 'variable-value';
        valueSpan.textContent = formatValue(variables[key]);
        
        varRow.appendChild(nameSpan);
        varRow.appendChild(valueSpan);
        frame.appendChild(varRow);
      });
    }

    return frame;
  }

  function formatValue(value) {
    if (typeof value === 'string') {
      return `"${value}"`;
    } else if (typeof value === 'object' && value !== null) {
      try {
        return JSON.stringify(value);
      } catch (e) {
        return String(value);
      }
    }
    return String(value);
  }

  function renderStepInfo(stepData) {
    const outputSection = document.getElementById('outputSection');
    const output = document.getElementById('output');
    
    let hasInfo = false;
    let infoText = '';

    // Show notes or code information
    if (stepData.note) {
      infoText += stepData.note;
      hasInfo = true;
    } else if (stepData.code) {
      infoText += `Executing: ${stepData.code}`;
      hasInfo = true;
    }

    if (hasInfo) {
      output.textContent = infoText;
      outputSection.style.display = 'block';
    } else {
      outputSection.style.display = 'none';
    }
  }

  function nextStep() {
    if (step < trace.length - 1) {
      step++;
      renderStep();
    }
  }

  function prevStep() {
    if (step > 0) {
      step--;
      renderStep();
    }
  }

  function editCode() {
    document.getElementById('visualizer').style.display = 'none';
    document.getElementById('codeInput').style.display = 'block';
    // Reset state
    trace = [];
    step = 0;
  }

  // Handle slider input
  document.getElementById('stepSlider').addEventListener('input', (e) => {
    step = parseInt(e.target.value);
    renderStep();
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (document.getElementById('visualizer').style.display !== 'none') {
      if (e.key === 'ArrowRight' || e.key === ' ') {
        e.preventDefault();
        nextStep();
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        prevStep();
      } else if (e.key === 'Escape') {
        editCode();
      }
    }
  });
</script>
</body>
</html>